!function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}();var Slots=function(){this.WINDOW_WIDTH=window.innerWidth,this.WINDOW_HEIGHT=window.innerHeight,this.bodyImagesSize={width:640,height:377},this.spinImagesSize={width:96,height:96},this.itemSize={width:84,height:84},this.realBodyImageWidth=~~this.WINDOW_WIDTH,this.ratio=this.realBodyImageWidth/this.bodyImagesSize.width,this.canvas=$("#canvas")[0],this.ctx=this.canvas.getContext("2d"),this.realBodyImageHeight=~~(this.ratio*this.bodyImagesSize.height),this.$spinBtn=$("#spinBtn"),this.$mkBetBtn=$("#mkBet"),this.$betLineBtn=$("#betLine"),this.$totalBet=$("#totalBet"),this.GAME_STATUS=0,this.score=0,this.ITEM_CNT=10,this.user={uid:0,user_name:0,wealth:0,user_info_ready:!1},this.items={icons:[],readyCnt:0},this.game={bet:1e3,lineCnt:1,betRate:1e3},this.wheel=null,this.layout=[]};Slots.prototype={init:function(){var a=this;this.wheel={top:~~(90*a.ratio),left:~~(85*a.ratio),width:~~(90*a.ratio),height:~~(240*a.ratio),gutter:~~(5*a.ratio),canvasWidth:~~(455*a.ratio),canvasHeight:~~(240*a.ratio),itemWidth:~~(a.itemSize.width*a.ratio),itemHeight:~~a.itemSize.height*a.ratio},this.$spinBtn.find("img").css("width",~~(this.ratio*this.spinImagesSize.width)),this.initCanvas(a),this.loadResource(a),this.getRandomLayout(a),this.getUserData(a),this.run(a),this.$spinBtn.on("tap click",function(){a.checkValidation&&(console.info("game start!"),a.run(a))}),this.$mkBetBtn.on("tap click",function(){this.value=a.game.betRate+ +this.value,a.game.bet=this.value,a.$totalBet.text(a.game.bet*a.game.lineCnt)}),this.$betLineBtn.on("tap click",function(){this.value<9?+this.value++:this.value=1,a.game.lineCnt=this.value,a.$totalBet.text(a.game.bet*a.game.lineCnt)})},getRandomLayout:function(a){a.layout=[];for(var b=14;b>=0;b--)a.layout.push(~~(Math.random()*a.ITEM_CNT+1))},initCanvas:function(a){$("#canvas").attr({width:a.wheel.canvasWidth,height:a.wheel.canvasHeight}).css({top:a.wheel.top,left:a.wheel.left})},checkValidation:function(a){return 0==a.GAME_STATUS&&a.user.user_info_ready&&a.user.wealth>=a.game.bet*a.game.lineCnt&&a.items.readyCnt==a.ITEM_CNT?!0:!1},loadResource:function(a){for(var b=a.ITEM_CNT;b>0;b--)a.items.icons[b]=new Image,a.items.icons[b].onload=function(){a.items.readyCnt++,a.items.readyCnt==a.ITEM_CNT&&$("#loading-wrapper").css({display:"none"})},a.items.icons[b].src="images/items/"+b+".png"},getUserData:function(a){a.user.wealth=1e4,a.user.user_info_ready=!0},spin:function(a){a.GAME_STATUS=1,setTimeout(function(){a.layout=[]},2e3)},run:function(a){function b(){var c=a.layout;c.forEach(function(a,b){(b+1)%3==0&&(i+=e.gutter+h,j=0),d.drawImage(k[a]||new Image,i,j,f,g),j+=g,14==b&&(i=0)}),requestAnimationFrame(b)}var c=a.canvas,d=this.ctx,e=a.wheel,f=e.itemWidth,g=e.itemHeight,h=e.width,i=0,j=0,k=a.items.icons;c.width=c.width,console.dir(a.layout),requestAnimationFrame(b)}},$("#loading-wrapper").css("height",window.innerHeight),$(function(){var a=new Slots;a.init()});